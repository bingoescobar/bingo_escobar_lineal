<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BINGO ESCOBAR - Sistema de Reservas</title>
    <style>
        :root {
            --primary-color: #d4af37;    /* Dorado mate principal */
            --secondary-color: #2c2c2c;  /* Negro secundario */
            --danger-color: #c41e3a;     /* Rojo tercer color */
            --accent-color: #1e3a8a;     /* Azul cuarto color */
            --warning-color: #e67e22;
            --light-color: #f8f9fa;
            --dark-color: #1a1a1a;
            --gold-color: #d4af37;
            --gold-light: #e6c86e;
            --gold-dark: #b8941f;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a, #3a3a3a);
            background-attachment: fixed;
            color: #e0e0e0;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--gold-dark));
            color: var(--secondary-color);
            padding: 40px 0 30px 0;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 3px solid var(--gold-light);
            position: relative;
            overflow: hidden;
        }
        
        .header-emojis {
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 1.5rem;
            opacity: 0.9;
            color: var(--secondary-color);
        }
        
        .admin-access-btn {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(44, 44, 44, 0.3);
            border: 2px solid var(--secondary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
            color: var(--secondary-color);
        }
        
        .admin-access-btn:hover {
            background: rgba(44, 44, 44, 0.5);
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }
        
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--primary-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1000;
            border: 1px solid var(--gold-light);
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .sync-status.connected {
            background: var(--accent-color);
            color: white;
        }
        
        .sync-status.disconnected {
            background: var(--danger-color);
            color: white;
        }
        
        .sync-status.error {
            background: var(--danger-color);
            color: white;
        }
        
        h1, h2 {
            margin-bottom: 15px;
        }
        
        h1 {
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.2);
            letter-spacing: 2px;
            color: var(--secondary-color);
            margin-top: 10px;
        }
        
        .subtitle {
            font-size: 1.4rem;
            font-weight: 300;
            opacity: 0.9;
            color: var(--secondary-color);
        }
        
        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .card {
            background: rgba(44, 44, 44, 0.9);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s;
            backdrop-filter: blur(10px);
            border: 1px solid var(--primary-color);
            color: #e0e0e0;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.2);
        }
        
        .admin-section {
            border-top: 5px solid var(--primary-color);
        }
        
        .user-section {
            border-top: 5px solid var(--accent-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(60, 60, 60, 0.8);
            color: #e0e0e0;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.3);
            background: rgba(70, 70, 70, 0.8);
        }
        
        input::placeholder {
            color: #999;
        }
        
        button {
            background: linear-gradient(135deg, var(--primary-color), var(--gold-dark));
            color: var(--secondary-color);
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: 1px solid var(--gold-light);
        }
        
        button:hover {
            background: linear-gradient(135deg, var(--gold-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--accent-color), #2d4ba8);
            color: white;
            border: 1px solid #3a5bc0;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #2d4ba8, var(--accent-color));
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #a51c30);
            color: white;
            border: 1px solid #d42e47;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #a51c30, var(--danger-color));
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d35400);
            color: white;
            border: 1px solid #e67e22;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d35400, var(--warning-color));
        }
        
        .numbers-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 10px 0;
            margin-top: 20px;
        }
        
        .numbers-column {
            min-width: 140px;
        }
        
        .column-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 5px;
            background: linear-gradient(135deg, var(--primary-color), var(--gold-dark));
            color: var(--secondary-color);
            border-radius: 5px;
            border: 1px solid var(--gold-light);
        }
        
        .numbers-grid {
            display: grid;
            gap: 10px;
        }
        
        .number-item {
            background-color: rgba(60, 60, 60, 0.8);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: #e0e0e0;
        }
        
        .number-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(212, 175, 55, 0.2);
        }
        
        .number-item.available {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(184, 148, 31, 0.1));
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .number-item.reserved {
            background: linear-gradient(135deg, var(--danger-color), #a51c30);
            color: white;
            border-color: #d42e47;
        }
        
        .number-item.paid {
            background: linear-gradient(135deg, var(--accent-color), #2d4ba8);
            color: white;
            border-color: #3a5bc0;
        }
        
        .number-item.full {
            background: linear-gradient(135deg, #555, #333);
            color: #999;
            border-color: #666;
            cursor: not-allowed;
        }
        
        .number-value {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .reserved-by {
            font-size: 0.75rem;
            font-weight: normal;
            opacity: 0.9;
            margin-top: 3px;
            word-break: break-word;
        }
        
        .reservations-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .reservation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #444;
            transition: background-color 0.3s;
            border-radius: 8px;
            background: rgba(60, 60, 60, 0.6);
        }
        
        .reservation-item:hover {
            background-color: rgba(80, 80, 80, 0.6);
        }
        
        .reservation-item.paid {
            background-color: rgba(30, 58, 138, 0.2);
            border-left: 4px solid var(--accent-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-buttons button {
            width: auto;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 4px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .status-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e0e0e0;
        }
        
        .status-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #555;
        }
        
        .available-color {
            background: linear-gradient(135deg, var(--primary-color), var(--gold-dark));
        }
        
        .reserved-color {
            background: linear-gradient(135deg, var(--danger-color), #a51c30);
        }
        
        .paid-color {
            background: linear-gradient(135deg, var(--accent-color), #2d4ba8);
        }
        
        .full-color {
            background: linear-gradient(135deg, #555, #333);
        }
        
        .user-reservation {
            background: rgba(60, 60, 60, 0.6);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid var(--primary-color);
        }
        
        .admin-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .admin-actions button {
            flex: 1;
        }
        
        .columns-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .columns-control select {
            flex: 1;
        }
        
        .columns-control button {
            width: auto;
        }
        
        .numbers-editor {
            margin-top: 15px;
        }
        
        .numbers-editor textarea {
            height: 100px;
            font-family: monospace;
            background: rgba(60, 60, 60, 0.8);
            color: #e0e0e0;
            border: 1px solid #555;
        }
        
        .cancel-btn-disabled {
            background: linear-gradient(135deg, #555, #444) !important;
            color: #999 !important;
            cursor: not-allowed !important;
            border: 1px solid #666 !important;
        }
        
        .cancel-btn-disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }
        
        .user-reservations-list {
            margin-top: 15px;
        }
        
        .user-reservation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(60, 60, 60, 0.6);
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }
        
        .user-reservation-item.paid {
            background: rgba(30, 58, 138, 0.2);
            border-left-color: var(--accent-color);
        }
        
        .admin-access {
            text-align: center;
            margin: 20px 0;
        }
        
        .admin-login {
            background: rgba(44, 44, 44, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: inline-block;
            border: 1px solid var(--primary-color);
        }
        
        .logout-btn {
            background: linear-gradient(135deg, #555, #444);
            color: #999;
            margin-top: 10px;
            border: 1px solid #666;
        }
        
        .logout-btn:hover {
            background: linear-gradient(135deg, #444, #555);
        }
        
        /* Nuevos estilos para el formulario fijo en la parte inferior */
        .fixed-form-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(44, 44, 44, 0.95);
            padding: 20px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.4);
            z-index: 100;
            border-top: 3px solid var(--primary-color);
            backdrop-filter: blur(10px);
            color: #e0e0e0;
        }
        
        .fixed-form-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .fixed-form-content .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .fixed-form-content .action-buttons {
            margin-top: 0;
        }
        
        /* Estilos para acciones de admin en n√∫meros */
        .admin-number-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        
        .admin-number-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            padding: 0;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .number-item:hover .admin-number-btn {
            opacity: 1;
        }
        
        /* Estilos para el modal de acceso administrativo */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: rgba(44, 44, 44, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 2px solid var(--primary-color);
            color: #e0e0e0;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-actions button {
            flex: 1;
        }
        
        @media (max-width: 767px) {
            .admin-actions {
                flex-direction: column;
            }
            
            .columns-control {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .numbers-column {
                min-width: 120px;
            }
            
            .fixed-form-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .fixed-form-content .action-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .fixed-form-content .action-buttons button {
                flex: 1;
            }
            
            .admin-access-btn {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
            }
            
            .header-emojis {
                font-size: 1.2rem;
                padding: 0 15px;
            }
        }
    </style>
</head>
<body>
    <div class="sync-status" id="sync-status">üîÑ Conectando...</div>
    
    <div class="container">
        <header>
            <div class="header-emojis">
                <div>üîûüí≤üé≤üé∞</div>
                <div>üé∞üé≤üí≤üîû</div>
            </div>
            <div class="admin-access-btn" id="admin-access-btn" title="Acceso Administrativo">‚öúÔ∏è</div>
            <h1>BINGO ESCOBAR</h1>
            <p class="subtitle">Sistema de Reserva de N√∫meros</p>
        </header>
        
        <div class="status-indicator">
            <div class="status-item">
                <div class="status-color available-color"></div>
                <span>Disponible</span>
            </div>
            <div class="status-item">
                <div class="status-color reserved-color"></div>
                <span>Reservado</span>
            </div>
            <div class="status-item">
                <div class="status-color paid-color"></div>
                <span>Pagado</span>
            </div>
        </div>
        
        <div class="columns">
            <!-- Secci√≥n de Administrador (oculta por defecto) -->
            <div id="admin-panel" class="card admin-section hidden">
                <h2>üîí Panel de Administraci√≥n</h2>
                
                <div class="form-group">
                    <label for="available-numbers">N√∫meros disponibles (separados por comas):</label>
                    <textarea id="available-numbers" placeholder="Ej: 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15"></textarea>
                    <button id="update-numbers" class="btn-success">Actualizar N√∫meros</button>
                </div>
                
                <div class="form-group">
                    <label>Configuraci√≥n de columnas:</label>
                    <div class="columns-control">
                        <select id="columns-number">
                            <option value="1">1 Columna</option>
                            <option value="2">2 Columnas</option>
                            <option value="3">3 Columnas</option>
                            <option value="4">4 Columnas</option>
                            <option value="5">5 Columnas</option>
                        </select>
                        <button id="update-columns" class="btn-success">Actualizar</button>
                    </div>
                </div>
                
                <div class="admin-actions">
                    <button id="reset-reservations" class="btn-warning">Reiniciar Todas las Reservas</button>
                    <button id="admin-logout-btn" class="logout-btn">Cerrar Sesi√≥n</button>
                </div>
            </div>
            
            <!-- Secci√≥n de Usuario -->
            <div class="card user-section">
                <h2>Reserva tus N√∫meros</h2>
                
                <div id="user-selection-info">
                    <p>Selecciona un n√∫mero disponible para reservarlo</p>
                </div>
                
                <h3>Selecciona tus N√∫meros</h3>
                <div class="numbers-container" id="user-numbers-container">
                    <!-- Las columnas de n√∫meros se generar√°n din√°micamente con JavaScript -->
                </div>
                
                <div id="reservation-details" class="hidden">
                    <div class="user-reservation">
                        <h3>Mis Reservas Activas</h3>
                        <div class="user-reservations-list" id="user-reservations-list">
                            <!-- Las reservas del usuario se mostrar√°n aqu√≠ -->
                        </div>
                        <div class="action-buttons">
                            <button id="cancel-all-reservations" class="btn-danger">Cancelar Todas mis Reservas</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario fijo en la parte inferior -->
    <div id="name-input-section" class="fixed-form-container hidden">
        <div class="fixed-form-content">
            <div class="form-group">
                <label for="user-name-input">Ingresa tu nombre para reservar el n√∫mero <span id="selected-number-display"></span>:</label>
                <input type="text" id="user-name-input" placeholder="Tu nombre completo">
            </div>
            <div class="action-buttons">
                <button id="confirm-reservation" class="btn-success">Confirmar Reserva</button>
                <button id="cancel-selection" class="btn-danger">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para acceso administrativo -->
    <div id="admin-login-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Acceso Administrativo</h3>
            <div class="form-group">
                <label for="admin-password">Contrase√±a:</label>
                <input type="password" id="admin-password" placeholder="Ingresa la contrase√±a">
            </div>
            <div class="modal-actions">
                <button id="admin-login-btn" class="btn-success">Acceder</button>
                <button id="cancel-admin-login" class="btn-danger">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <script>
        // ================= CONFIGURACI√ìN FIREBASE =================
        const firebaseConfig = {
            apiKey: "AIzaSyD_3dQ2lLQvX_9Y0qQwz8wz8wz8wz8wz8wz",
            authDomain: "bingo-escobar.firebaseapp.com",
            databaseURL: "https://bingo-escobar-default-rtdb.firebaseio.com",
            projectId: "bingo-escobar",
            storageBucket: "bingo-escobar.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };

        // ================= ESTADO GLOBAL =================
        const appState = {
            columnsNumber: 1,
            availableNumbers: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],
            numbers: [],
            reservations: [],
            selectedNumber: null,
            currentUserName: null,
            adminLoggedIn: false,
            adminPassword: "admin123",
            firebaseInitialized: false
        };

        // ================= INICIALIZACI√ìN FIREBASE =================
        function initializeFirebase() {
            try {
                // Verificar si Firebase ya est√° inicializado
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                appState.firebaseInitialized = true;
                updateSyncStatus('üü¢ Conectado', 'connected');
                console.log('Firebase inicializado correctamente');
                
                // Inicializar la aplicaci√≥n despu√©s de Firebase
                initializeApp();
                startRealtimeSync();
                
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                updateSyncStatus('üî¥ Sin conexi√≥n', 'disconnected');
                // Usar localStorage como fallback
                loadFromLocalStorage();
                initializeApp();
            }
        }

        // ================= SINCRONIZACI√ìN EN TIEMPO REAL =================
        function startRealtimeSync() {
            if (!appState.firebaseInitialized) return;
            
            const db = firebase.database();
            
            // Escuchar cambios en las reservas
            db.ref('reservations').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    appState.reservations = Object.values(data);
                    updateNumbersFromReservations();
                    renderNumbers();
                    
                    // Si el usuario tiene reservas activas, mostrarlas
                    if (appState.currentUserName) {
                        showUserReservations(appState.currentUserName);
                    }
                } else {
                    // No hay datos en Firebase, inicializar vac√≠o
                    appState.reservations = [];
                    updateNumbersFromReservations();
                    renderNumbers();
                }
            });

            // Escuchar cambios en la configuraci√≥n
            db.ref('config').on('value', (snapshot) => {
                const config = snapshot.val();
                if (config) {
                    appState.columnsNumber = config.columnsNumber || 1;
                    appState.availableNumbers = config.availableNumbers || [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
                    initializeNumbers();
                    renderNumbers();
                    updateNumbersEditor();
                }
            });
        }

        // ================= GUARDAR EN FIREBASE =================
        async function saveToFirebase() {
            if (!appState.firebaseInitialized) {
                saveToLocalStorage();
                return;
            }

            try {
                const db = firebase.database();
                
                // Guardar reservas
                const reservationsObj = {};
                appState.reservations.forEach(reservation => {
                    reservationsObj[reservation.id] = reservation;
                });
                await db.ref('reservations').set(reservationsObj);
                
                // Guardar configuraci√≥n
                await db.ref('config').set({
                    columnsNumber: appState.columnsNumber,
                    availableNumbers: appState.availableNumbers
                });
                
                updateSyncStatus('üü¢ Guardado', 'connected');
            } catch (error) {
                console.error('Error guardando en Firebase:', error);
                updateSyncStatus('üî¥ Error guardando', 'disconnected');
                saveToLocalStorage(); // Fallback a localStorage
            }
        }

        // ================= FUNCIONES AUXILIARES =================
        function updateSyncStatus(message, className) {
            const statusElement = document.getElementById('sync-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `sync-status ${className}`;
            }
        }

        function updateNumbersFromReservations() {
            // Reiniciar todos los n√∫meros
            appState.numbers.forEach(number => {
                number.reservedBy = null;
                number.paid = false;
            });

            // Aplicar reservas activas
            appState.reservations.forEach(reservation => {
                if (!reservation.cancelled) {
                    const number = appState.numbers.find(n => 
                        n.uniqueId === reservation.uniqueId
                    );
                    if (number) {
                        number.reservedBy = reservation.userName;
                        number.paid = reservation.paid;
                    }
                }
            });
        }

        // ================= FUNCIONES DEL SISTEMA =================
        function initializeNumbers() {
            appState.numbers = [];
            
            // Para cada columna, crear n√∫meros independientes
            for (let col = 0; col < appState.columnsNumber; col++) {
                appState.availableNumbers.forEach(numberId => {
                    appState.numbers.push({
                        id: numberId,
                        column: col,
                        reservedBy: null,
                        paid: false,
                        uniqueId: `${col}-${numberId}`
                    });
                });
            }
            
            // Actualizar n√∫meros con las reservas existentes
            updateNumbersFromReservations();
        }

        function updateNumbersEditor() {
            const availableNumbersInput = document.getElementById('available-numbers');
            const columnsNumberSelect = document.getElementById('columns-number');
            
            if (availableNumbersInput) {
                availableNumbersInput.value = appState.availableNumbers.join(', ');
            }
            if (columnsNumberSelect) {
                columnsNumberSelect.value = appState.columnsNumber;
            }
        }

        function renderNumbers() {
            renderUserNumbers();
        }

        function renderUserNumbers() {
            const container = document.getElementById('user-numbers-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let col = 0; col < appState.columnsNumber; col++) {
                const columnElement = document.createElement('div');
                columnElement.className = 'numbers-column';
                
                const headerElement = document.createElement('div');
                headerElement.className = 'column-header';
                headerElement.textContent = `Columna ${col + 1}`;
                columnElement.appendChild(headerElement);
                
                const gridElement = document.createElement('div');
                gridElement.className = 'numbers-grid';
                
                const columnNumbers = appState.numbers.filter(n => n.column === col);
                
                columnNumbers.forEach(number => {
                    const numberElement = document.createElement('div');
                    numberElement.className = 'number-item';
                    
                    if (number.reservedBy !== null) {
                        if (number.paid) {
                            numberElement.classList.add('paid');
                        } else {
                            numberElement.classList.add('reserved');
                        }
                        numberElement.innerHTML = `
                            <div class="number-value">${number.id}</div>
                            <div class="reserved-by">${number.reservedBy}</div>
                        `;
                        numberElement.style.cursor = 'default';
                        
                        // A√±adir botones de administraci√≥n si est√° logueado
                        if (appState.adminLoggedIn) {
                            const adminActions = document.createElement('div');
                            adminActions.className = 'admin-number-actions';
                            
                            const markPaidBtn = document.createElement('button');
                            markPaidBtn.className = 'admin-number-btn btn-success';
                            markPaidBtn.innerHTML = '‚úì';
                            markPaidBtn.title = number.paid ? 'Marcar como no pagado' : 'Marcar como pagado';
                            markPaidBtn.onclick = (e) => {
                                e.stopPropagation();
                                markAsPaid(number.uniqueId);
                            };
                            
                            const cancelBtn = document.createElement('button');
                            cancelBtn.className = 'admin-number-btn btn-danger';
                            cancelBtn.innerHTML = '‚úï';
                            cancelBtn.title = 'Cancelar reserva';
                            cancelBtn.onclick = (e) => {
                                e.stopPropagation();
                                cancelReservation(number.uniqueId);
                            };
                            
                            adminActions.appendChild(markPaidBtn);
                            adminActions.appendChild(cancelBtn);
                            numberElement.appendChild(adminActions);
                        }
                    } else {
                        numberElement.classList.add('available');
                        numberElement.innerHTML = `
                            <div class="number-value">${number.id}</div>
                            <div class="reserved-by">Disponible</div>
                        `;
                        numberElement.addEventListener('click', () => selectNumber(number.uniqueId));
                    }
                    
                    gridElement.appendChild(numberElement);
                });
                
                columnElement.appendChild(gridElement);
                container.appendChild(columnElement);
            }
        }

        // ================= FUNCIONES DE USUARIO =================
        function selectNumber(uniqueId) {
            const number = appState.numbers.find(n => n.uniqueId === uniqueId);
            if (!number) return;
            
            if (number.reservedBy !== null) {
                alert('Este n√∫mero ya est√° reservado');
                return;
            }
            
            appState.selectedNumber = number;
            
            const selectedNumberDisplay = document.getElementById('selected-number-display');
            const userNameInput = document.getElementById('user-name-input');
            const nameInputSection = document.getElementById('name-input-section');
            const reservationDetails = document.getElementById('reservation-details');
            
            if (selectedNumberDisplay) selectedNumberDisplay.textContent = number.id;
            if (userNameInput) userNameInput.value = '';
            if (nameInputSection) nameInputSection.classList.remove('hidden');
            if (reservationDetails) reservationDetails.classList.add('hidden');
        }

        function cancelSelection() {
            appState.selectedNumber = null;
            const nameInputSection = document.getElementById('name-input-section');
            if (nameInputSection) nameInputSection.classList.add('hidden');
        }

        async function confirmReservation() {
            const userNameInput = document.getElementById('user-name-input');
            if (!userNameInput) return;
            
            const userName = userNameInput.value.trim();
            if (!userName) {
                alert('Por favor ingresa tu nombre');
                return;
            }
            
            if (!appState.selectedNumber) return;
            
            const number = appState.selectedNumber;
            
            if (number.reservedBy !== null) {
                alert('Este n√∫mero ya est√° reservado');
                cancelSelection();
                return;
            }
            
            const reservation = {
                id: Date.now(),
                numberId: number.id,
                column: number.column,
                uniqueId: number.uniqueId,
                userName: userName,
                timestamp: new Date().toISOString(),
                paid: false,
                cancelled: false
            };
            
            appState.reservations.push(reservation);
            number.reservedBy = userName;
            appState.currentUserName = userName;
            
            await saveToFirebase();
            
            renderNumbers();
            
            const nameInputSection = document.getElementById('name-input-section');
            if (nameInputSection) nameInputSection.classList.add('hidden');
            
            showUserReservations(userName);
            
            alert(`¬°Reserva exitosa! Has reservado el n√∫mero ${number.id}`);
        }

        async function cancelUserReservation(reservationId) {
            const reservation = appState.reservations.find(r => r.id === reservationId);
            if (!reservation) return;
            
            if (reservation.paid) {
                alert('No se puede cancelar una reserva que ya est√° pagada');
                return;
            }
            
            reservation.cancelled = true;
            
            const number = appState.numbers.find(n => n.uniqueId === reservation.uniqueId);
            if (number) {
                number.reservedBy = null;
                number.paid = false;
            }
            
            await saveToFirebase();
            
            renderNumbers();
            showUserReservations(appState.currentUserName);
            
            alert('Reserva cancelada exitosamente');
        }

        async function cancelAllUserReservations() {
            if (!appState.currentUserName) return;
            
            const userReservations = appState.reservations.filter(r => 
                r.userName === appState.currentUserName && !r.cancelled && !r.paid
            );
            
            if (userReservations.length === 0) {
                alert('No tienes reservas que se puedan cancelar');
                return;
            }
            
            if (confirm(`¬øEst√°s seguro de que deseas cancelar tus ${userReservations.length} reservas?`)) {
                userReservations.forEach(reservation => {
                    reservation.cancelled = true;
                    
                    const number = appState.numbers.find(n => n.uniqueId === reservation.uniqueId);
                    if (number) {
                        number.reservedBy = null;
                        number.paid = false;
                    }
                });
                
                await saveToFirebase();
                renderNumbers();
                showUserReservations(appState.currentUserName);
                
                alert(`Todas tus ${userReservations.length} reservas han sido canceladas`);
            }
        }

        function showUserReservations(userName) {
            if (!userName) return;
            
            const userReservations = appState.reservations.filter(r => 
                r.userName === userName && !r.cancelled
            );
            
            const list = document.getElementById('user-reservations-list');
            const reservationDetails = document.getElementById('reservation-details');
            
            if (!list || !reservationDetails) return;
            
            list.innerHTML = '';
            
            if (userReservations.length === 0) {
                reservationDetails.classList.add('hidden');
                return;
            }
            
            userReservations.forEach(reservation => {
                const reservationElement = document.createElement('div');
                reservationElement.className = 'user-reservation-item';
                
                if (reservation.paid) {
                    reservationElement.classList.add('paid');
                }
                
                reservationElement.innerHTML = `
                    <div>
                        <strong>N√∫mero: ${reservation.numberId}</strong><br>
                        <small>Reservado el: ${new Date(reservation.timestamp).toLocaleString()}</small>
                        ${reservation.paid ? '<br><span style="color: #3a5bc0; font-weight: bold;">‚úì PAGADO</span>' : ''}
                    </div>
                    <div class="action-buttons">
                        ${!reservation.paid ? 
                            `<button class="btn-danger" onclick="cancelUserReservation(${reservation.id})">Cancelar</button>` : 
                            '<span style="color: #7f8c8d; font-style: italic;">No cancelable</span>'
                        }
                    </div>
                `;
                
                list.appendChild(reservationElement);
            });
            
            reservationDetails.classList.remove('hidden');
        }

        // ================= FUNCIONES ADMINISTRATIVAS =================
        function showAdminLoginModal() {
            const modal = document.getElementById('admin-login-modal');
            const passwordInput = document.getElementById('admin-password');
            
            if (modal) modal.classList.remove('hidden');
            if (passwordInput) passwordInput.value = '';
        }

        function hideAdminLoginModal() {
            const modal = document.getElementById('admin-login-modal');
            if (modal) modal.classList.add('hidden');
        }

        function adminLogin() {
            const passwordInput = document.getElementById('admin-password');
            if (!passwordInput) return;
            
            const password = passwordInput.value;
            if (password === appState.adminPassword) {
                appState.adminLoggedIn = true;
                const adminPanel = document.getElementById('admin-panel');
                
                if (adminPanel) adminPanel.classList.remove('hidden');
                if (passwordInput) passwordInput.value = '';
                
                hideAdminLoginModal();
                
                // Volver a renderizar n√∫meros para mostrar botones de admin
                renderNumbers();
                
                alert('Acceso concedido al panel de administraci√≥n');
            } else {
                alert('Contrase√±a incorrecta');
            }
        }

        function adminLogout() {
            appState.adminLoggedIn = false;
            const adminPanel = document.getElementById('admin-panel');
            
            if (adminPanel) adminPanel.classList.add('hidden');
            
            // Volver a renderizar n√∫meros para ocultar botones de admin
            renderNumbers();
            
            alert('Sesi√≥n administrativa cerrada');
        }

        async function updateAvailableNumbers() {
            if (!appState.adminLoggedIn) {
                alert('Acceso denegado. Debes iniciar sesi√≥n como administrador.');
                return;
            }

            const numbersTextInput = document.getElementById('available-numbers');
            if (!numbersTextInput) return;
            
            const numbersText = numbersTextInput.value;
            const numbersArray = numbersText.split(',')
                .map(num => parseInt(num.trim()))
                .filter(num => !isNaN(num) && num > 0);
            
            if (numbersArray.length > 0) {
                appState.availableNumbers = [...new Set(numbersArray)].sort((a, b) => a - b);
                initializeNumbers();
                await saveToFirebase();
                renderNumbers();
                alert(`N√∫meros actualizados: ${appState.availableNumbers.join(', ')}`);
            } else {
                alert('Por favor ingresa n√∫meros v√°lidos separados por comas');
            }
        }

        async function updateColumnsNumber() {
            if (!appState.adminLoggedIn) {
                alert('Acceso denegado. Debes iniciar sesi√≥n como administrador.');
                return;
            }

            const columnsNumberSelect = document.getElementById('columns-number');
            if (!columnsNumberSelect) return;
            
            const newColumns = parseInt(columnsNumberSelect.value);
            if (newColumns > 0 && newColumns <= 5) {
                appState.columnsNumber = newColumns;
                initializeNumbers();
                await saveToFirebase();
                renderNumbers();
                alert(`N√∫mero de columnas actualizado: ${newColumns}`);
            } else {
                alert('Por favor selecciona un n√∫mero v√°lido de columnas');
            }
        }

        async function resetAllReservations() {
            if (!appState.adminLoggedIn) {
                alert('Acceso denegado. Debes iniciar sesi√≥n como administrador.');
                return;
            }

            if (confirm('¬øEst√°s seguro de que deseas reiniciar todas las reservas? Esta acci√≥n no se puede deshacer.')) {
                appState.reservations = [];
                appState.currentUserName = null;
                initializeNumbers();
                await saveToFirebase();
                renderNumbers();
                
                const nameInputSection = document.getElementById('name-input-section');
                const reservationDetails = document.getElementById('reservation-details');
                
                if (nameInputSection) nameInputSection.classList.add('hidden');
                if (reservationDetails) reservationDetails.classList.add('hidden');
                
                alert('Todas las reservas han sido reiniciadas');
            }
        }

        async function markAsPaid(uniqueId) {
            if (!appState.adminLoggedIn) {
                alert('Acceso denegado. Debes iniciar sesi√≥n como administrador.');
                return;
            }

            const reservation = appState.reservations.find(r => r.uniqueId === uniqueId && !r.cancelled);
            if (reservation) {
                reservation.paid = !reservation.paid;
                
                const number = appState.numbers.find(n => n.uniqueId === reservation.uniqueId);
                if (number) {
                    number.paid = reservation.paid;
                }
                
                await saveToFirebase();
                renderNumbers();
                
                if (appState.currentUserName && reservation.userName === appState.currentUserName) {
                    showUserReservations(appState.currentUserName);
                }
            }
        }

        async function cancelReservation(uniqueId) {
            if (!appState.adminLoggedIn) {
                alert('Acceso denegado. Debes iniciar sesi√≥n como administrador.');
                return;
            }

            const reservation = appState.reservations.find(r => r.uniqueId === uniqueId && !r.cancelled);
            if (reservation) {
                if (confirm(`¬øEst√°s seguro de que deseas cancelar la reserva del n√∫mero ${reservation.numberId} por ${reservation.userName}?`)) {
                    reservation.cancelled = true;
                    
                    const number = appState.numbers.find(n => n.uniqueId === reservation.uniqueId);
                    if (number) {
                        number.reservedBy = null;
                        number.paid = false;
                    }
                    
                    await saveToFirebase();
                    renderNumbers();
                    
                    if (appState.currentUserName && reservation.userName === appState.currentUserName) {
                        showUserReservations(appState.currentUserName);
                    }
                    
                    alert('Reserva cancelada exitosamente');
                }
            }
        }

        // ================= LOCAL STORAGE (FALLBACK) =================
        function saveToLocalStorage() {
            localStorage.setItem('reservationApp', JSON.stringify({
                columnsNumber: appState.columnsNumber,
                availableNumbers: appState.availableNumbers,
                numbers: appState.numbers,
                reservations: appState.reservations,
                currentUserName: appState.currentUserName
            }));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('reservationApp');
            if (saved) {
                const parsed = JSON.parse(saved);
                appState.columnsNumber = parsed.columnsNumber || 1;
                appState.availableNumbers = parsed.availableNumbers || [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
                appState.numbers = parsed.numbers || [];
                appState.reservations = parsed.reservations || [];
                appState.currentUserName = parsed.currentUserName || null;
            }
        }

        // ================= INICIALIZACI√ìN =================
        function initializeApp() {
            // Inicializar n√∫meros primero
            initializeNumbers();
            
            // Configurar event listeners
            document.getElementById('update-numbers').addEventListener('click', updateAvailableNumbers);
            document.getElementById('update-columns').addEventListener('click', updateColumnsNumber);
            document.getElementById('reset-reservations').addEventListener('click', resetAllReservations);
            document.getElementById('confirm-reservation').addEventListener('click', confirmReservation);
            document.getElementById('cancel-selection').addEventListener('click', cancelSelection);
            document.getElementById('cancel-all-reservations').addEventListener('click', cancelAllUserReservations);
            document.getElementById('admin-login-btn').addEventListener('click', adminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', adminLogout);
            document.getElementById('admin-access-btn').addEventListener('click', showAdminLoginModal);
            document.getElementById('cancel-admin-login').addEventListener('click', hideAdminLoginModal);
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('admin-login-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideAdminLoginModal();
                }
            });
            
            // Asegurar que el panel de administraci√≥n est√© oculto al inicio
            document.getElementById('admin-panel').classList.add('hidden');
            
            // Renderizar interfaz
            updateNumbersEditor();
            renderNumbers();
        }

        // Inicializar la aplicaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

    </script>
</body>
</html>