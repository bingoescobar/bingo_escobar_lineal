<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BINGO ESCOBAR - Sistema de Reservas</title>
    <style>
        :root {
            --primary-color: #e74c3c;
            --secondary-color: #2ecc71;
            --danger-color: #c0392b;
            --warning-color: #f39c12;
            --light-color: #f8f9fa;
            --dark-color: #2c3e50;
            --gold-color: #ffd700;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-attachment: fixed;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), #c0392b);
            color: white;
            padding: 30px 0;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--gold-color);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "ðŸŽ° ðŸŽ² ðŸŽ¯";
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 1.5rem;
            opacity: 0.8;
        }
        
        header::after {
            content: "ðŸŽ¯ ðŸŽ² ðŸŽ°";
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 1.5rem;
            opacity: 0.8;
        }
        
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            border: 1px solid #ddd;
        }
        
        .sync-status.connected {
            background: var(--secondary-color);
            color: white;
        }
        
        .sync-status.disconnected {
            background: var(--warning-color);
            color: white;
        }
        
        .sync-status.error {
            background: var(--danger-color);
            color: white;
        }
        
        h1, h2 {
            margin-bottom: 15px;
        }
        
        h1 {
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.2);
            letter-spacing: 2px;
            color: var(--gold-color);
        }
        
        .subtitle {
            font-size: 1.4rem;
            font-weight: 300;
            opacity: 0.9;
            color: white;
        }
        
        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
        }
        
        .admin-section {
            border-top: 5px solid var(--primary-color);
        }
        
        .user-section {
            border-top: 5px solid var(--secondary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }
        
        button {
            background: linear-gradient(135deg, var(--primary-color), #c0392b);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        button:hover {
            background: linear-gradient(135deg, #c0392b, var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--secondary-color), #27ae60);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60, var(--secondary-color));
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #922b21);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #922b21, var(--danger-color));
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e67e22, var(--warning-color));
        }
        
        .numbers-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 10px 0;
            margin-top: 20px;
        }
        
        .numbers-column {
            min-width: 140px;
        }
        
        .column-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 5px;
            background: var(--primary-color);
            color: white;
            border-radius: 5px;
        }
        
        .numbers-grid {
            display: grid;
            gap: 10px;
        }
        
        .number-item {
            background-color: var(--light-color);
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .number-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .number-item.available {
            background: linear-gradient(135deg, #e8f4fc, #d1ecf1);
            border-color: var(--primary-color);
            color: var(--dark-color);
        }
        
        .number-item.reserved {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            border-color: #e67e22;
        }
        
        .number-item.paid {
            background: linear-gradient(135deg, var(--secondary-color), #27ae60);
            color: white;
            border-color: #27ae60;
        }
        
        .number-item.full {
            background: linear-gradient(135deg, var(--danger-color), #922b21);
            color: white;
            border-color: #c0392b;
            cursor: not-allowed;
        }
        
        .number-value {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .reserved-by {
            font-size: 0.75rem;
            font-weight: normal;
            opacity: 0.9;
            margin-top: 3px;
            word-break: break-word;
        }
        
        .reservations-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .reservation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
            border-radius: 8px;
        }
        
        .reservation-item:hover {
            background-color: #f8f9fa;
        }
        
        .reservation-item.paid {
            background-color: rgba(46, 204, 113, 0.15);
            border-left: 4px solid var(--secondary-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-buttons button {
            width: auto;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 4px;
        }
        
        .hidden {
            display: none;
        }
        
        .status-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .available-color {
            background: linear-gradient(135deg, #e8f4fc, #d1ecf1);
            border: 1px solid var(--primary-color);
        }
        
        .reserved-color {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }
        
        .paid-color {
            background: linear-gradient(135deg, var(--secondary-color), #27ae60);
        }
        
        .full-color {
            background: linear-gradient(135deg, var(--danger-color), #922b21);
        }
        
        .user-reservation {
            background: linear-gradient(135deg, #e8f4fc, #d1ecf1);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid var(--primary-color);
        }
        
        .admin-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .admin-actions button {
            flex: 1;
        }
        
        .columns-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .columns-control select {
            flex: 1;
        }
        
        .columns-control button {
            width: auto;
        }
        
        .numbers-editor {
            margin-top: 15px;
        }
        
        .numbers-editor textarea {
            height: 100px;
            font-family: monospace;
        }
        
        .cancel-btn-disabled {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d) !important;
            cursor: not-allowed !important;
        }
        
        .cancel-btn-disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }
        
        .user-reservations-list {
            margin-top: 15px;
        }
        
        .user-reservation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }
        
        .user-reservation-item.paid {
            background: rgba(46, 204, 113, 0.1);
            border-left-color: var(--secondary-color);
        }
        
        .admin-access {
            text-align: center;
            margin: 20px 0;
        }
        
        .admin-login {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .logout-btn {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            margin-top: 10px;
        }
        
        .logout-btn:hover {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
        }
        
        @media (max-width: 767px) {
            .admin-actions {
                flex-direction: column;
            }
            
            .columns-control {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .numbers-column {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="sync-status" id="sync-status">ðŸ”„ Conectando...</div>
    
    <div class="container">
        <header>
            <h1>BINGO ESCOBAR</h1>
            <p class="subtitle">Sistema de Reserva de NÃºmeros - En Tiempo Real</p>
        </header>
        
        <!-- Acceso para administradores -->
        <div class="admin-access">
            <div class="admin-login">
                <h3>Acceso Administrativo</h3>
                <div class="form-group">
                    <label for="admin-password">ContraseÃ±a:</label>
                    <input type="password" id="admin-password" placeholder="Ingresa la contraseÃ±a">
                </div>
                <button id="admin-login-btn" class="btn-success">Acceder al Panel</button>
                <button id="admin-logout-btn" class="logout-btn hidden">Cerrar SesiÃ³n</button>
            </div>
        </div>
        
        <div class="status-indicator">
            <div class="status-item">
                <div class="status-color available-color"></div>
                <span>Disponible</span>
            </div>
            <div class="status-item">
                <div class="status-color reserved-color"></div>
                <span>Reservado</span>
            </div>
            <div class="status-item">
                <div class="status-color paid-color"></div>
                <span>Pagado</span>
            </div>
        </div>
        
        <div class="columns">
            <!-- SecciÃ³n de Administrador (oculta por defecto) -->
            <div id="admin-panel" class="card admin-section hidden">
                <h2>ðŸ”’ Panel de AdministraciÃ³n</h2>
                
                <div class="form-group">
                    <label for="available-numbers">NÃºmeros disponibles (separados por comas):</label>
                    <textarea id="available-numbers" placeholder="Ej: 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15"></textarea>
                    <button id="update-numbers" class="btn-success">Actualizar NÃºmeros</button>
                </div>
                
                <div class="form-group">
                    <label>ConfiguraciÃ³n de columnas:</label>
                    <div class="columns-control">
                        <select id="columns-number">
                            <option value="1">1 Columna</option>
                            <option value="2">2 Columnas</option>
                            <option value="3">3 Columnas</option>
                            <option value="4">4 Columnas</option>
                            <option value="5">5 Columnas</option>
                        </select>
                        <button id="update-columns" class="btn-success">Actualizar</button>
                    </div>
                </div>
                
                <div class="admin-actions">
                    <button id="reset-reservations" class="btn-warning">Reiniciar Todas las Reservas</button>
                </div>
                
                <h3>NÃºmeros Disponibles</h3>
                <div class="numbers-container" id="admin-numbers-container">
                    <!-- Las columnas de nÃºmeros se generarÃ¡n dinÃ¡micamente con JavaScript -->
                </div>
                
                <h3>Reservas Activas</h3>
                <div class="reservations-list" id="admin-reservations-list">
                    <!-- Las reservas se mostrarÃ¡n aquÃ­ -->
                </div>
            </div>
            
            <!-- SecciÃ³n de Usuario -->
            <div class="card user-section">
                <h2>Reserva tus NÃºmeros</h2>
                
                <div id="user-selection-info">
                    <p>Selecciona un nÃºmero disponible para reservarlo</p>
                </div>
                
                <h3>Selecciona tus NÃºmeros</h3>
                <div class="numbers-container" id="user-numbers-container">
                    <!-- Las columnas de nÃºmeros se generarÃ¡n dinÃ¡micamente con JavaScript -->
                </div>
                
                <!-- Este formulario solo aparece cuando se selecciona un nÃºmero -->
                <div id="name-input-section" class="hidden">
                    <div class="user-reservation">
                        <h3>Completar Reserva</h3>
                        <div class="form-group">
                            <label for="user-name-input">Ingresa tu nombre para reservar el nÃºmero <span id="selected-number-display"></span>:</label>
                            <input type="text" id="user-name-input" placeholder="Tu nombre completo">
                        </div>
                        <div class="action-buttons">
                            <button id="confirm-reservation" class="btn-success">Confirmar Reserva</button>
                            <button id="cancel-selection" class="btn-danger">Cancelar</button>
                        </div>
                    </div>
                </div>
                
                <div id="reservation-details" class="hidden">
                    <div class="user-reservation">
                        <h3>Mis Reservas Activas</h3>
                        <div class="user-reservations-list" id="user-reservations-list">
                            <!-- Las reservas del usuario se mostrarÃ¡n aquÃ­ -->
                        </div>
                        <div class="action-buttons">
                            <button id="cancel-all-reservations" class="btn-danger">Cancelar Todas mis Reservas</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <script>
        // ================= CONFIGURACIÃ“N FIREBASE =================
        const firebaseConfig = {
            apiKey: "AIzaSyD_3dQ2lLQvX_9Y0qQwz8wz8wz8wz8wz8wz",
            authDomain: "bingo-escobar.firebaseapp.com",
            databaseURL: "https://bingo-escobar-default-rtdb.firebaseio.com",
            projectId: "bingo-escobar",
            storageBucket: "bingo-escobar.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };

        // ================= ESTADO GLOBAL =================
        const appState = {
            columnsNumber: 1,
            availableNumbers: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],
            numbers: [],
            reservations: [],
            selectedNumber: null,
            currentUserName: null,
            adminLoggedIn: false,
            adminPassword: "admin123",
            firebaseInitialized: false
        };

        // ================= INICIALIZACIÃ“N FIREBASE =================
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                appState.firebaseInitialized = true;
                updateSyncStatus('ðŸŸ¢ Conectado', 'connected');
                console.log('Firebase inicializado correctamente');
                startRealtimeSync();
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                updateSyncStatus('ðŸ”´ Error Firebase', 'disconnected');
                // Usar localStorage como fallback
                loadFromLocalStorage();
                initializeApp();
            }
        }

        // ================= SINCRONIZACIÃ“N EN TIEMPO REAL =================
        function startRealtimeSync() {
            const db = firebase.database();
            
            // Escuchar cambios en las reservas
            db.ref('reservations').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    appState.reservations = Object.values(data);
                    updateNumbersFromReservations();
                    renderNumbers();
                    renderAdminReservations();
                    
                    // Si el usuario tiene reservas activas, mostrarlas
                    if (appState.currentUserName) {
                        showUserReservations(appState.currentUserName);
                    }
                }
            });

            // Escuchar cambios en la configuraciÃ³n
            db.ref('config').on('value', (snapshot) => {
                const config = snapshot.val();
                if (config) {
                    appState.columnsNumber = config.columnsNumber || 1;
                    appState.availableNumbers = config.availableNumbers || [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
                    initializeNumbers();
                    renderNumbers();
                    updateNumbersEditor();
                }
            });
        }

        // ================= GUARDAR EN FIREBASE =================
        async function saveToFirebase() {
            if (!appState.firebaseInitialized) {
                saveToLocalStorage();
                return;
            }

            try {
                const db = firebase.database();
                
                // Guardar reservas
                const reservationsObj = {};
                appState.reservations.forEach(reservation => {
                    reservationsObj[reservation.id] = reservation;
                });
                await db.ref('reservations').set(reservationsObj);
                
                // Guardar configuraciÃ³n
                await db.ref('config').set({
                    columnsNumber: appState.columnsNumber,
                    availableNumbers: appState.availableNumbers
                });
                
                updateSyncStatus('ðŸŸ¢ Guardado', 'connected');
            } catch (error) {
                console.error('Error guardando en Firebase:', error);
                updateSyncStatus('ðŸ”´ Error guardando', 'disconnected');
                saveToLocalStorage(); // Fallback a localStorage
            }
        }

        // ================= FUNCIONES AUXILIARES =================
        function updateSyncStatus(message, className) {
            const statusElement = document.getElementById('sync-status');
            statusElement.textContent = message;
            statusElement.className = `sync-status ${className}`;
        }

        function updateNumbersFromReservations() {
            // Reiniciar todos los nÃºmeros
            appState.numbers.forEach(number => {
                number.reservedBy = null;
                number.paid = false;
            });

            // Aplicar reservas activas
            appState.reservations.forEach(reservation => {
                if (!reservation.cancelled) {
                    const number = appState.numbers.find(n => 
                        n.id === reservation.numberId && n.column === reservation.column
                    );
                    if (number) {
                        number.reservedBy = reservation.userName;
                        number.paid = reservation.paid;
                    }
                }
            });
        }

        // ================= FUNCIONES DEL SISTEMA =================
        function initializeNumbers() {
            appState.numbers = [];
            
            // Para cada columna, crear nÃºmeros independientes
            for (let col = 0; col < appState.columnsNumber; col++) {
                appState.availableNumbers.forEach(numberId => {
                    appState.numbers.push({
                        id: numberId,
                        column: col,
                        reservedBy: null,
                        paid: false,
                        uniqueId: `${col}-${numberId}`
                    });
                });
            }
            
            // Actualizar nÃºmeros con las reservas existentes
            updateNumbersFromReservations();
        }

        function updateNumbersEditor() {
            document.getElementById('available-numbers').value = appState.availableNumbers.join(', ');
            document.getElementById('columns-number').value = appState.columnsNumber;
        }

        function renderNumbers() {
            renderAdminNumbers();
            renderUserNumbers();
        }

        function renderAdminNumbers() {
            const container = document.getElementById('admin-numbers-container');
            container.innerHTML = '';
            
            for (let col = 0; col < appState.columnsNumber; col++) {
                const columnElement = document.createElement('div');
                columnElement.className = 'numbers-column';
                
                const headerElement = document.createElement('div');
                headerElement.className = 'column-header';
                headerElement.textContent = `Columna ${col + 1}`;
                columnElement.appendChild(headerElement);
                
                const gridElement = document.createElement('div');
                gridElement.className = 'numbers-grid';
                
                const columnNumbers = appState.numbers.filter(n => n.column === col);
                
                columnNumbers.forEach(number => {
                    const numberElement = document.createElement('div');
                    numberElement.className = 'number-item';
                    
                    if (number.reservedBy !== null) {
                        if (number.paid) {
                            numberElement.classList.add('paid');
                        } else {
                            numberElement.classList.add('reserved');
                        }
                    } else {
                        numberElement.classList.add('available');
                    }
                    
                    numberElement.innerHTML = `
                        <div class="number-value">${number.id}</div>
                        ${number.reservedBy ? `<div class="reserved-by">${number.reservedBy}</div>` : ''}
                    `;
                    
                    gridElement.appendChild(numberElement);
                });
                
                columnElement.appendChild(gridElement);
                container.appendChild(columnElement);
            }
        }

        function renderUserNumbers() {
            const container = document.getElementById('user-numbers-container');
            container.innerHTML = '';
            
            for (let col = 0; col < appState.columnsNumber; col++) {
                const columnElement = document.createElement('div');
                columnElement.className = 'numbers-column';
                
                const headerElement = document.createElement('div');
                headerElement.className = 'column-header';
                headerElement.textContent = `Columna ${col + 1}`;
                columnElement.appendChild(headerElement);
                
                const gridElement = document.createElement('div');
                gridElement.className = 'numbers-grid';
                
                const columnNumbers = appState.numbers.filter(n => n.column === col);
                
                columnNumbers.forEach(number => {
                    const numberElement = document.createElement('div');
                    numberElement.className = 'number-item';
                    
                    if (number.reservedBy !== null) {
                        if (number.paid) {
                            numberElement.classList.add('paid');
                        } else {
                            numberElement.classList.add('reserved');
                        }
                        numberElement.innerHTML = `
                            <div class="number-value">${number.id}</div>
                            <div class="reserved-by">${number.reservedBy}</div>
                        `;
                    } else {
                        numberElement.classList.add('available');
                        numberElement.innerHTML = `
                            <div class="number-value">${number.id}</div>
                            <div class="reserved-by">Disponible</div>
                        `;
                        numberElement.addEventListener('click', () => selectNumber(number.uniqueId));
                    }
                    
                    gridElement.appendChild(numberElement);
                });
                
                columnElement.appendChild(gridElement);
                container.appendChild(columnElement);
            }
        }

        function renderAdminReservations() {
            const list = document.getElementById('admin-reservations-list');
            list.innerHTML = '';
            
            const activeReservations = appState.reservations.filter(r => !r.cancelled);
            
            if (activeReservations.length === 0) {
                list.innerHTML = '<p>No hay reservas activas</p>';
                return;
            }
            
            activeReservations.forEach(reservation => {
                const reservationElement = document.createElement('div');
                reservationElement.className = 'reservation-item';
                
                if (reservation.paid) {
                    reservationElement.classList.add('paid');
                }
                
                reservationElement.innerHTML = `
                    <div>
                        <strong>NÃºmero: ${reservation.numberId}</strong><br>
                        <span>Reservado por: ${reservation.userName}</span><br>
                        <small>${new Date(reservation.timestamp).toLocaleString()}</small>
                    </div>
                    <div class="action-buttons">
                        <button class="${reservation.paid ? 'btn-success' : ''}" 
                                onclick="markAsPaid(${reservation.id})">
                            ${reservation.paid ? 'Pagado âœ“' : 'Marcar como Pagado'}
                        </button>
                    </div>
                `;
                
                list.appendChild(reservationElement);
            });
        }

        // ================= FUNCIONES DE USUARIO =================
        function selectNumber(uniqueId) {
            const number = appState.numbers.find(n => n.uniqueId === uniqueId);
            if (!number) return;
            
            if (number.reservedBy !== null) {
                alert('Este nÃºmero ya estÃ¡ reservado');
                return;
            }
            
            appState.selectedNumber = number;
            
            document.getElementById('selected-number-display').textContent = number.id;
            document.getElementById('user-name-input').value = '';
            document.getElementById('name-input-section').classList.remove('hidden');
            document.getElementById('reservation-details').classList.add('hidden');
        }

        function cancelSelection() {
            appState.selectedNumber = null;
            document.getElementById('name-input-section').classList.add('hidden');
        }

        async function confirmReservation() {
            const userName = document.getElementById('user-name-input').value.trim();
            if (!userName) {
                alert('Por favor ingresa tu nombre');
                return;
            }
            
            if (!appState.selectedNumber) return;
            
            const number = appState.selectedNumber;
            
            if (number.reservedBy !== null) {
                alert('Este nÃºmero ya estÃ¡ reservado');
                cancelSelection();
                return;
            }
            
            const reservation = {
                id: Date.now(),
                numberId: number.id,
                column: number.column,
                uniqueId: number.uniqueId,
                userName: userName,
                timestamp: new Date().toISOString(),
                paid: false,
                cancelled: false
            };
            
            appState.reservations.push(reservation);
            number.reservedBy = userName;
            appState.currentUserName = userName;
            
            await saveToFirebase();
            
            renderNumbers();
            renderAdminReservations();
            
            document.getElementById('name-input-section').classList.add('hidden');
            showUserReservations(userName);
            
            alert(`Â¡Reserva exitosa! Has reservado el nÃºmero ${number.id}`);
        }

        async function cancelUserReservation(reservationId) {
            const reservation = appState.reservations.find(r => r.id === reservationId);
            if (!reservation) return;
            
            if (reservation.paid) {
                alert('No se puede cancelar una reserva que ya estÃ¡ pagada');
                return;
            }
            
            reservation.cancelled = true;
            
            const number = appState.numbers.find(n => n.uniqueId === reservation.uniqueId);
            if (number) {
                number.reservedBy = null;
                number.paid = false;
            }
            
            await saveToFirebase();
            
            renderNumbers();
            renderAdminReservations();
            showUserReservations(appState.currentUserName);
            
            alert('Reserva cancelada exitosamente');
        }

        async function cancelAllUserReservations() {
            if (!appState.currentUserName) return;
            
            const userReservations = appState.reservations.filter(r => 
                r.userName === appState.currentUserName && !r.cancelled && !r.paid
            );
            
            if (userReservations.length === 0) {
                alert('No tienes reservas que se puedan cancelar');
                return;
            }
            
            if (confirm(`Â¿EstÃ¡s seguro de que deseas cancelar tus ${userReservations.length} reservas?`)) {
                userReservations.forEach(reservation => {
                    reservation.cancelled = true;
                    
                    const number = appState.numbers.find(n => n.uniqueId === reservation.uniqueId);
                    if (number) {
                        number.reservedBy = null;
                        number.paid = false;
                    }
                });
                
                await saveToFirebase();
                renderNumbers();
                renderAdminReservations();
                showUserReservations(appState.currentUserName);
                
                alert(`Todas tus ${userReservations.length} reservas han sido canceladas`);
            }
        }

        function showUserReservations(userName) {
            if (!userName) return;
            
            const userReservations = appState.reservations.filter(r => 
                r.userName === userName && !r.cancelled
            );
            
            const list = document.getElementById('user-reservations-list');
            list.innerHTML = '';
            
            if (userReservations.length === 0) {
                document.getElementById('reservation-details').classList.add('hidden');
                return;
            }
            
            userReservations.forEach(reservation => {
                const reservationElement = document.createElement('div');
                reservationElement.className = 'user-reservation-item';
                
                if (reservation.paid) {
                    reservationElement.classList.add('paid');
                }
                
                reservationElement.innerHTML = `
                    <div>
                        <strong>NÃºmero: ${reservation.numberId}</strong><br>
                        <small>Reservado el: ${new Date(reservation.timestamp).toLocaleString()}</small>
                        ${reservation.paid ? '<br><span style="color: #27ae60; font-weight: bold;">âœ“ PAGADO</span>' : ''}
                    </div>
                    <div class="action-buttons">
                        ${!reservation.paid ? 
                            `<button class="btn-danger" onclick="cancelUserReservation(${reservation.id})">Cancelar</button>` : 
                            '<span style="color: #7f8c8d; font-style: italic;">No cancelable</span>'
                        }
                    </div>
                `;
                
                list.appendChild(reservationElement);
            });
            
            document.getElementById('reservation-details').classList.remove('hidden');
        }

        // ================= FUNCIONES ADMINISTRATIVAS =================
        function adminLogin() {
            const password = document.getElementById('admin-password').value;
            if (password === appState.adminPassword) {
                appState.adminLoggedIn = true;
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-logout-btn').classList.remove('hidden');
                document.getElementById('admin-password').value = '';
                alert('Acceso concedido al panel de administraciÃ³n');
            } else {
                alert('ContraseÃ±a incorrecta');
            }
        }

        function adminLogout() {
            appState.adminLoggedIn = false;
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('admin-logout-btn').classList.add('hidden');
            alert('SesiÃ³n administrativa cerrada');
        }

        async function updateAvailableNumbers() {
            if (!appState.adminLoggedIn) {
                alert('Acceso denegado. Debes iniciar sesiÃ³n como administrador.');
                return;
            }

            const numbersText = document.getElementById('available-numbers').value;
            const numbersArray = numbersText.split(',')
                .map(num => parseInt(num.trim()))
                .filter(num => !isNaN(num) && num > 0);
            
            if (numbersArray.length > 0) {
                appState.availableNumbers = [...new Set(numbersArray)].sort((a, b) => a - b);
                initializeNumbers();
                await saveToFirebase();
                renderNumbers();
                renderAdminReservations();
                alert(`NÃºmeros actualizados: ${appState.availableNumbers.join(', ')}`);
            } else {
                alert('Por favor ingresa nÃºmeros vÃ¡lidos separados por comas');
            }
        }

        async function updateColumnsNumber() {
            if (!appState.adminLoggedIn) {
                alert('Acceso denegado. Debes iniciar sesiÃ³n como administrador.');
                return;
            }

            const newColumns = parseInt(document.getElementById('columns-number').value);
            if (newColumns > 0 && newColumns <= 5) {
                appState.columnsNumber = newColumns;
                initializeNumbers();
                await saveToFirebase();
                renderNumbers();
                alert(`NÃºmero de columnas actualizado: ${newColumns}`);
            } else {
                alert('Por favor selecciona un nÃºmero vÃ¡lido de columnas');
            }
        }

        async function resetAllReservations() {
            if (!appState.adminLoggedIn) {
                alert('Acceso denegado. Debes iniciar sesiÃ³n como administrador.');
                return;
            }

            if (confirm('Â¿EstÃ¡s seguro de que deseas reiniciar todas las reservas? Esta acciÃ³n no se puede deshacer.')) {
                appState.reservations = [];
                appState.currentUserName = null;
                initializeNumbers();
                await saveToFirebase();
                renderNumbers();
                renderAdminReservations();
                document.getElementById('name-input-section').classList.add('hidden');
                document.getElementById('reservation-details').classList.add('hidden');
                alert('Todas las reservas han sido reiniciadas');
            }
        }

        async function markAsPaid(reservationId) {
            if (!appState.adminLoggedIn) {
                alert('Acceso denegado. Debes iniciar sesiÃ³n como administrador.');
                return;
            }

            const reservation = appState.reservations.find(r => r.id === reservationId);
            if (reservation) {
                reservation.paid = !reservation.paid;
                
                const number = appState.numbers.find(n => n.uniqueId === reservation.uniqueId);
                if (number) {
                    number.paid = reservation.paid;
                }
                
                await saveToFirebase();
                renderAdminReservations();
                renderNumbers();
                
                if (appState.currentUserName && reservation.userName === appState.currentUserName) {
                    showUserReservations(appState.currentUserName);
                }
            }
        }

        // ================= LOCAL STORAGE (FALLBACK) =================
        function saveToLocalStorage() {
            localStorage.setItem('reservationApp', JSON.stringify({
                columnsNumber: appState.columnsNumber,
                availableNumbers: appState.availableNumbers,
                numbers: appState.numbers,
                reservations: appState.reservations,
                currentUserName: appState.currentUserName
            }));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('reservationApp');
            if (saved) {
                const parsed = JSON.parse(saved);
                appState.columnsNumber = parsed.columnsNumber || 1;
                appState.availableNumbers = parsed.availableNumbers || [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
                appState.numbers = parsed.numbers || [];
                appState.reservations = parsed.reservations || [];
                appState.currentUserName = parsed.currentUserName || null;
            }
        }

        // ================= INICIALIZACIÃ“N =================
        function initializeApp() {
            initializeNumbers();
            updateNumbersEditor();
            renderNumbers();
            renderAdminReservations();
            
            document.getElementById('update-numbers').addEventListener('click', updateAvailableNumbers);
            document.getElementById('update-columns').addEventListener('click', updateColumnsNumber);
            document.getElementById('reset-reservations').addEventListener('click', resetAllReservations);
            document.getElementById('confirm-reservation').addEventListener('click', confirmReservation);
            document.getElementById('cancel-selection').addEventListener('click', cancelSelection);
            document.getElementById('cancel-all-reservations').addEventListener('click', cancelAllUserReservations);
            document.getElementById('admin-login-btn').addEventListener('click', adminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', adminLogout);
            
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('admin-logout-btn').classList.add('hidden');
        }

        // Inicializar la aplicaciÃ³n cuando se carga la pÃ¡gina
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

    </script>
</body>
</html>